---
- name: "Expose defaults for other tasks to use"
  set_fact:
    software_path: "{{ software_path }}"
    containers_path: "{{ containers_path }}"

- name: "Determine base path for {{ name }}"
  set_fact:
    base_path: "{{ containers_path if container | default(false) else software_path }}"

- name: "Determine install path for {{ name }}"
  set_fact:
    install_path: >-
      {{
        (
        [base_path, 'apps', name] + ([version] if version is defined else [])
        if not (container | default(false))
        else
        [base_path, name] + ([version] if version is defined else [])
        ) | join('/')
      }}

- name: "Capture software info for {{ name }}"
  set_fact:
    software_info: "{{ software_info | default({}) | combine({ (name): {
      'version': version | default(''),
      'install_path': install_path | default('')
      }}) }}"

- name: "Determine modulefile path for {{ name }}"
  set_fact:
    modulefile_path: "{{ ([base_path, 'modulefiles', name]) | join('/') }}"

- name: "Determine if {{ name }} should be rebuilt"
  set_fact:
    software_force_rebuild: "{{ force_rebuild or (name in software_rebuild_list | default([])) }}"

- name: "Check if {{ name }} is already installed"
  stat:
    path: "{{ install_path }}"
  register: software_installed

- name: "Set software skip flag for {{ name }}"
  set_fact:
    software_skip: "{{ software_done.get(name) | default(false) or (software_installed.stat.exists and not software_force_rebuild) }}"

- name: "Set installation directories for {{ name }}"
  set_fact:
    install_dirs: "{{ [install_path, modulefile_path] + (extra_dirs | default([])) }}"
  when: not software_skip

- name: "Create installation directories for {{ name }}"
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop: "{{ install_dirs }}"
  when: not software_skip

- name: "Create modulefile for {{ name }}"
  template:
    src: "lmod-template.j2"
    dest: "{{ modulefile_path }}/{{ version if version is defined else name }}.lua"
    mode: "0644"
  when: not software_skip

- name: "Mark {{ name }} as installed"
  set_fact:
    software_done: "{{ software_done | combine({ name: true }) }}"
  when: not software_skip
