---
- hosts: localhost
  become: true
  gather_facts: yes

  vars_files:
    - vars/software_groups.yml

  vars:
    software_path: "/software/el9"
    containers_path: "/reference/containers"

    lmod_template_path: "/etc/modulefiles/lmod-template.lua"

    software: ""
    software_groups: ""

    force_rebuild: false

    rebuild_software: ""

    software_list: "{{ software.split(',') if software != '' else [] }}"
    software_groups_list: "{{ software_groups.split(',') if software_groups != '' else [] }}"
    software_rebuild_list: "{{ rebuild_software.split(',') if rebuild_software != '' else [] }}"

    group_software: "{{ software_groups_list | map('trim') | map('lower') | map('extract', software_groups_mapping) | sum(start=[]) }}"

    software_to_install: "{{ (software_list + group_software + software_rebuild_list) | unique }}"

    invalid_groups: "{{ software_groups_list | difference(software_groups_mapping.keys() | list) }}"

    software_done: []
    software_failed: []

  tasks:
    - name: "Fail if invalid software groups are provided"
      fail:
        msg: |
          The following software groups do not exist: {{ invalid_groups }}

          Available software groups: {{ software_groups_mapping.keys() | list }}
      when: invalid_groups | length > 0

    - name: "Check if any software was selected"
      fail:
        msg: |
          No software or software groups were selected.
          To install software, provide one or more software names or software groups, for example:

            ansible-playbook site.yml -e "software=tmux,python_3"
            ansible-playbook site.yml -e "software_groups=common,sequence_tools"

          To rebuild software:

            ansible-playbook site.yml -e "rebuild_software=virtualenv"
            # Rebuilds only the explicitly listed software without dependencies

            ansible-playbook site.yml -e "software=virtualenv,udunits" -e "force_rebuild=true"
            # Rebuilds all the selected software including dependencies

          Available software groups: {{ software_groups_mapping.keys() | list }}
      when: software_to_install | length == 0

    - name: "Ensure Lmod template exists on remote"
      copy:
        src: "lmod-template.lua"
        dest: "{{ lmod_template_path }}"
        mode: "0644"

    - name: "Install selected software"
      include_tasks: software_runner.yml
      loop: "{{ software_to_install }}"
      loop_control:
        loop_var: software_name

    - name: "Software installation summary"
      debug:
        msg: |
          Software installation summary for host {{ inventory_hostname }}:

            Installed: {{ software_done | length }} -> {{ software_done | join(', ') }}
            Skipped: {{ (software_to_install | difference(software_done + software_failed)) | length }} -> {{ (software_to_install | difference(software_done + software_failed)) | join(', ') }}
            Failed: {{ software_failed | length }} -> {{ software_failed | join(', ') }}
